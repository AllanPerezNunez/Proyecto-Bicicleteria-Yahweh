<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Agendamientos</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
        <link rel="icon" href="/media/imagenes_bd/yahweh.png" type="image/x-icon">
        <meta http-equiv="Cache-Control" content="no-store" />
    </head>
    <body>

    {% csrf_token %}

<!--=========================================NAVBAR==================================================-->
  <nav class="navbar" aria-label="Light offcanvas navbar" style="background-color: #1ddf1b;position:fixed;top:0;width:100%;z-index:100;">
            <div class="container-fluid">
              <button class="navbar-toggler" style="background-color: #e50c57; color: white;" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span><label  style="margin-left: 10px;">Acciones</label>
              </button>
              <div class="offcanvas offcanvas-start" data-bs-scroll="true" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasWithBothOptionsLabel">
                <div class="offcanvas-header">
                  <h5 class="offcanvas-title" id="offcanvasWithBothOptionsLabel">Acciones</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                  <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                    <li class="nav-item">
                      <a class="nav-link active" aria-current="page" href="/dashboard">Inicio</a>
                      <a class="nav-link active" aria-current="page" href="/registrarproducto">Agregar Productos</a>
                      <a class="nav-link active" aria-current="page" href="/agregarhoras">Agregar Horas de Agendamiento</a>
                      <a class="nav-link active" aria-current="page" href="/agregarcategorias">Agregar Categorias</a>
                      <a class="nav-link active" aria-current="page" href="/listarproductos">Listar Productos</a>
                      <a class="nav-link active" aria-current="page" href="/listarusuarios">Listar Usuarios</a>
                      <a class="nav-link active" aria-current="page" href="/listarcategorias">Listar Categorias</a>
                      <a class="nav-link active" aria-current="page" href="/lista_agendas">Agendamientos</a>
                      <a class="nav-link active" aria-current="page" href="/seguimiento_admin">Seguimiento Compras online</a>
                      <a class="nav-link active" aria-current="page" href="/presencial_admin">Despacho Presencial</a> 
                      <a class="nav-link active" aria-current="page" href="/listar_historial">Historial de Acciones</a>
                      <a class="nav-link active" aria-current="page" href="/cerrar Sesion">Cerrar Sesion</a>  
                    </li>
                  </ul>
                  
                </div>
              </div>
              <a class="navbar-brand" href="/dashboard" style="display: flex; align-items: center; text-decoration: none;position:relative;left:-70%;"><!--HREF DEBE LLEVAR AL DASHBOARD-->
                <img src="/media/imagenes_bd/yahweh.png" style="width:40px; height:40px;">
                <h3 style="font-size:20px; color: black;">Bicicletería Yahweh</h3>
              </a>
            </div>
  </nav>
<!--=================================FIN NAVBAR===========================================================-->



    <br/>

    
    <div class="container" style="margin-top:5%;">
      <h1 class="text-center" style="margin-bottom:3%;">Listado de Agendamientos</h1>
        {% comment %} {% if r%}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>¡Felicidades!</strong> {{r}}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}

        {% if r2%}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>¡Caspita!</strong> {{r2}}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %} {% endcomment %}

        <div id="mensaje" class="mt-3"></div>
        
        <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab" tabindex="0" style="border:2px solid #e50c57;margin-bottom:5%">
        <table border="1" class="table text-center">
            <tr style="background-color:#e50c57;width:100%;color:white;">
                <th>Id</th>
                <th>Rut</th>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Descripcion</th>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Telefono</th>
                <th>Estado</th>
                {% comment %} <th></th> {% endcomment %}
            </tr>

            {% for x in rep %}

            <tr>
              <td> {{x.id }} </td>
              <td> {{x.usuario.rut }} </td>
              <td> {{x.usuario.nombre }} </td>
              <td> {{x.usuario.apellido }} </td>
              <td> {{x.observaciones}} </td>
              <td> {{x.fecha}} </td>
              <td> {{x.hora_agendada}} </td>
              <td> {{x.usuario.telefono }} </td>
              <td> 
                  <select onchange="cambiarEstado({{ x.id }}, this.value)">
                    <option value="Pendiente" {% if x.estado_reparacion.descripcion == "Pendiente" %}selected{% endif %}>Pendiente</option>
                    <option value="Completada" {% if x.estado_reparacion.descripcion == "Completada" %}selected{% endif %}>Completada</option>
                    <option value="Cancelada" {% if x.estado_reparacion.descripcion == "Cancelada" %}selected{% endif %}>Cancelada</option>
                  </select>
                  <!-- Estado actual: {{ x.estado_reparacion.descripcion }} -->
              </td>
            {% comment %} <td> <button type="button" class="btn btn-danger" style="background-color:#e50c57;border:none;font-weight:bold;" onclick="botonEliminar({{x.id}})">Eliminar</button> </td> {% endcomment %}
            </tr>


            {% endfor %} 

        </table>
        </div>
    </div>


      <!--SCRIPT PARA MODIFICAR EL ESTADO DEL AGENDAMIENTO-->
      <script>
        function cambiarEstado(reparacionId, nuevoEstado) {
          fetch(`/actualizar_estado/${reparacionId}/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ estado: nuevoEstado })
          })
          .then(response => response.json())
          .then(data => {
            const mensaje = document.getElementById("mensaje");

            if (data.success) {
              mensaje.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                  <strong>¡Felicitaciones!</strong> El estado se ha actualizado correctamente
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            } else {
              mensaje.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                  <strong>Error:</strong> No se pudo actualizar el estado
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            }

            // Ocultar el mensaje después de 3 segundos
            setTimeout(() => {
              mensaje.innerHTML = "";
            }, 3000);
          })
          .catch(error => {
            console.error("Error:", error);
          });
        }
      </script>   
        
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
    
    </body>
</html>


