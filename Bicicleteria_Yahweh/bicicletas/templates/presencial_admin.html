<!doctype html>
<html lang="es">
<!--========================================================================================-->
<!--                                    HEAD                                                -->
<!--========================================================================================-->    
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yahweh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link rel="icon" href="/media/imagenes_bd/yahweh.png" type="image/x-icon">
    
    <style>
    /* Estilo por defecto para pantallas grandes (computadores, laptops) */
        .alerta-login-error {
            margin-top: 4%; /* Margen para pantallas grandes */
        }

        /* Media Query para dispositivos móviles (ej. ancho de pantalla de 768px o menos) */
        @media (max-width: 768px) {
            .alerta-login-error {
                margin-top: 13%; /* Margen superior más grande para móviles */
            }
        }

        /* Opcional: Otra Media Query para pantallas aún más pequeñas si lo necesitas */
        @media (max-width: 480px) {
            .alerta-login-error {
                margin-top: 10%; /* Margen para celulares muy pequeños */
            }
        }
      </style>

  </head>

<!--========================================================================================-->
<!--                                    BODY                                                -->
<!--========================================================================================-->    

  <body>
    <!--===================================================================================-->
    <!--                         BARRA DE NAVEGACIÓN       -->
    <!--===================================================================================-->
    <nav class="navbar" aria-label="Light offcanvas navbar" style="background-color: #1ddf1b;position:fixed;top:0;width:100%;z-index:100;">
            <div class="container-fluid">
              <button class="navbar-toggler" style="background-color: #e50c57; color: white;" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span><label  style="margin-left: 10px;">Acciones</label>
              </button>
              <div class="offcanvas offcanvas-start" data-bs-scroll="true" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasWithBothOptionsLabel">
                <div class="offcanvas-header">
                  <h5 class="offcanvas-title" id="offcanvasWithBothOptionsLabel">Acciones</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                  <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                    <li class="nav-item">
                      <a class="nav-link active" aria-current="page" href="/dashboard">Inicio</a>
                      <a class="nav-link active" aria-current="page" href="/registrarproducto">Agregar Productos</a>
                      <a class="nav-link active" aria-current="page" href="/agregarhoras">Agregar Horas de Agendamiento</a>
                      <a class="nav-link active" aria-current="page" href="/agregarcategorias">Agregar Categorias</a>
                      <a class="nav-link active" aria-current="page" href="/listarproductos">Listar Productos</a>
                      <a class="nav-link active" aria-current="page" href="/listarusuarios">Listar Usuarios</a>
                      <a class="nav-link active" aria-current="page" href="/listarcategorias">Listar Categorias</a>
                      <a class="nav-link active" aria-current="page" href="/lista_agendas">Agendamientos</a>
                      <a class="nav-link active" aria-current="page" href="/seguimiento_admin">Seguimiento Compras online</a>
                      <a class="nav-link active" aria-current="page" href="/presencial_admin">Despacho Presencial</a> 
                      <a class="nav-link active" aria-current="page" href="/listar_historial">Historial de Acciones</a>
                      <a class="nav-link active" aria-current="page" href="/cerrar Sesion">Cerrar Sesion</a>  
                    </li>
                  </ul>
                  
                </div>
              </div>
              <a class="navbar-brand" href="/dashboard" style="display: flex; align-items: center; text-decoration: none;position:relative;left:-70%;"><!--HREF DEBE LLEVAR AL DASHBOARD-->
                <img src="/media/imagenes_bd/yahweh.png" style="width:40px; height:40px;">
                <h3 style="font-size:20px; color: black;">Bicicletería Yahweh</h3>
              </a>
            </div>
  </nav>
<!--===================================================================================-->
<!--                            Despacho Presencial                                   -->
<!--===================================================================================-->
    {% if mensaje %}
    <div class="alert alert-warning alert-dismissible fade show alerta-login-error" role="alert">
      <strong>Oh vaya!</strong> {{ mensaje }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
    
    {# HistorialDeCompras.html - Corrected filename based on common sense #}
{# This file contains the table of purchases with 'SEGUIR' buttons #}

    <div class="container" style="margin-top:7%;">
        <h1 class="text-center" style="margin-bottom:3%;">Despacho Presencial</h1>
        <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab" tabindex="0" style="border:2px solid #e50c57;margin-bottom:5%;width:110%;margin-left:-5%;">
            <table border="1" class="table text-center" >
                <tr bgcolor="#e50c57" style="color:white;">
                    <th>N° Factura</th>
                    <th>Compra</th>
                    <th>Precio</th>
                    <th>Unidades</th>
                    <th>Fecha del Pedido</th>
                    <th>Dirección</th>
                    <th>Estado de Compra</th>
                    <th>Acciones</th> {# Changed "Cambiar Estado" to "Acciones" #}
                </tr>

                {% for compra in compras %}
                <tr>
                    <td>{{ compra.nro_factura }}</td>
                    <td>{{ compra.producto__nombre }}</td>
                    <td>{{ compra.producto__precio }}</td>
                    <td>{{ compra.cantidad }}</td>
                    <td>{{ compra.fecha_compra|date:"d M Y H:i" }}</td>
                    <td>{{ compra.direccion }}</td>
                    <td>{{ compra.estado_compra }}</td>
                    <td>
                        <form action="{% url 'confirmarCompra' %}" method="post" class="form-confirmar-compra">
                            {% csrf_token %}
                            <input type="hidden" name="id_compra_pres" value="{{ compra.id }}">
                            <input type="hidden" name="nro_factura_pres" value="{{ compra.nro_factura }}">
                            <button type="submit" class="btn btn-success" style="background-color:#1ddf1b;border:none;font-weight:bold;" name='accion_extra' value='COMPRADO'>Comprado</button>
                            <button type="button" class="btn btn-danger btn-rechazar"
                                    style="background-color:red;border:none;font-weight:bold;"
                                    data-bs-toggle="modal" data-bs-target="#rechazarModal"
                                    data-id-compra="{{ compra.id }}"
                                    data-nro-factura="{{ compra.nro_factura }}">
                                Rechazar
                            </button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="8">No Tiene Productos que recibir</td></tr> {# Updated colspan #}
                {% endfor %}
            </table>
        </div>
    </div>

    <div class="modal fade" id="rechazarModal" tabindex="-1" aria-labelledby="rechazarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rechazarModalLabel">Motivo de Rechazo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{% url 'confirmarCompra' %}" method="post" id="formRechazarModal">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input type="hidden" name="id_compra_pres" id="modalIdCompra">
                        <input type="hidden" name="nro_factura_pres" id="modalNroFactura">
                        <input type="hidden" name="accion_extra" value="RECHAZADO">
                        <div class="mb-3">
                            <label for="descripcionRechazo" class="form-label">Por favor, ingrese el motivo del rechazo:</label>
                            <textarea class="form-control" id="descripcionRechazo" name="descripcion_rechazo" rows="3" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Confirmar Rechazo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% comment %} Script para manejar el modal y pasar los datos {% endcomment %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var rechazarModal = document.getElementById('rechazarModal');
        rechazarModal.addEventListener('show.bs.modal', function (event) {
            // Botón que disparó el modal
            var button = event.relatedTarget; 
            // Extraer información de los atributos data-*
            var idCompra = button.getAttribute('data-id-compra');
            var nroFactura = button.getAttribute('data-nro-factura');

            // Actualizar los campos hidden del formulario dentro del modal
            var modalIdCompraInput = rechazarModal.querySelector('#modalIdCompra');
            var modalNroFacturaInput = rechazarModal.querySelector('#modalNroFactura');
            
            modalIdCompraInput.value = idCompra;
            modalNroFacturaInput.value = nroFactura;
        });
    });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  </body>

</html>